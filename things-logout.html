<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-tooltip/paper-tooltip.html">

<link rel="import" href="../things-global-behavior/things-global-behavior.html">
<link rel="import" href="../things-msg-box-behavior/things-msg-box-behavior.html">

<dom-module id="things-logout">
  <template>
    <paper-icon-button id="logout" icon="{{icon}}"></paper-icon-button>
    <paper-tooltip for="logout" offset="0">Logout</paper-tooltip>
  </template>

  <script>
    Polymer({
      is: 'things-logout',

      behaviors: [
        Things.GlobalBehavior,
        Things.MsgBoxBehavior
      ],

      properties: {
        logoutPath: {
          type: String,
          value: ''
        },

        logoutUrl: {
          type: String,
          computed: '_computeLogoutUrl(globals.baseUrl, logoutPath)'
        },

        _signoutAjax: {
          type: Object,
          value: {}
        },

        icon: {
          type: String,
          value: 'exit-to-app'
        }
      },

      listeners: {
        'logout.tap': 'logout'
      },

      _computeLogoutUrl: function(baseUrl, url) {
        return baseUrl + '/' + url;
      },

      logout: function(e) {
        console.log(this.isSignedIn());
        if (this.isSignedIn()) {
          this.signout(this.logoutUrl);
        }
      },

      isSignedIn: function() {
        return this.get('globals.user') ? true : false;
      },

      signout: function(logoutUrl) {
        this.set('_signoutAjax', document.createElement('iron-ajax'));
        this.listen(this._signoutAjax, 'response', '_signoutSuccess');
        this.listen(this._signoutAjax, 'error', '_signoutFailure');

        this._signoutAjax.url = logoutUrl;
        this._signoutAjax.method = 'POST';
        this._signoutAjax.withCredentials = true;
        this._signoutAjax.generateRequest();
      },

      _signoutSuccess: function(event) {
        this.set('globals.user', null);
        this.fire('things-logout-succeed');
        this.unlisten(this._signoutAjax, 'response', '_signoutSuccess');
        this.unlisten(this._signoutAjax, 'error', '_signoutFailure');
        location.reload(true);
      },

      _signoutFailure: function(event) {
        if (event && event.detail && event.detail.error && event.detail.error.target && event.detail.error.target.statusText) {
          this.openInfoMsg(event.detail.error.target.statusText);
        } else {
          this.openInfoMsg('Failed to Logout');
        }
      }
    });
  </script>
</dom-module>
