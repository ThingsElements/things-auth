<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-input/iron-input.html">
<link rel="import" href="../../bower_components/iron-form/iron-form.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/gold-email-input/gold-email-input.html">
<link rel="import" href="../../bower_components/things-global-behavior/things-global-behavior.html">
<link rel="import" href="../../bower_components/things-msg-box-behavior/things-msg-box-behavior.html">
<link rel="import" href="../../bower_components/things-i18n-msg/things-i18n-msg.html">

<link rel="import" href="../../bower_components/things-auth/things-signup.html">
<link rel="import" href="../../bower_components/things-auth/things-password-init.html">
<link rel="import" href="../../bower_components/things-auth/things-request-active.html">

<!--
A things login form asking for login and password.

Example:

<things-login data-route="login"
              route ="{{route}}"
              title="Things Label Management"
              login-path="login"
              content-type="application/x-www-form-urlencoded"
              success-route="list"
              username-input-label="ID"
              password-input-label="Password"
              submit-label ="Submit"
              Reset-label = "Reset">
  <img avatar src="https://maps.gstatic.com/tactile/pane/default_geocode-1x.png"/>
</things-login>

@demo demo/index.html
-->

<dom-module id="things-login">
  <template>
    <style is="custom-style">
      :host {
        --color: green;
        display: block;
        @apply(--things-home-image);
        background-image : var(--things-home-image-url);
        background-position : var(--things-home-image-position);
      }
      @media screen and (max-width:999px) {
        :host{
          @apply(--things-home-image-small);
          margin:90px 58px 0 58px !important
        }
      }
      paper-material {
        @apply(--things-login);
      }

      .header {
        display: block;
        padding-top: 30px;
        font-size: 35px;
        color: var(--things-primary-text-color);
        font-weight: 300;
        text-align: center;
        line-height: 40px;
      }

      .header:before {
        content: "";
        display: block;
        margin: auto;
        margin-top: -90px;
        width: 80px;
        height: 85px;
        background: url(/images/icon-nametag.png) no-repeat;
      }

      paper-input::shadow input:-webkit-autofill {
        background: #fff;
        -webkit-box-shadow: inset 0 0 0px 9999px white;
      }

      form {
        @apply(--things-loose-padding);
        padding-top: 10px;
      }

      paper-button {
        @apply(--things-login-link-button);
      }
      paper-button:hover{
        color:#dd2c00;
      }

      #submitButton {
        @apply(--things-login-button);
      }
      #submitButton:hover{
        background-color:#9c7964;
        color:#fff;
      }

      div {
        margin-top: 10px;
      }
    </style>

    <paper-material elevation="1" on-keypress="keypressHandler">
      <things-i18n-msg auto msgid="text.login_failure" msg="{{tLoginFailure}}" hidden>Login failure.</things-i18n-msg>
      <things-i18n-msg auto msgid="label.id" msg="{{lUserId}}" hidden>ID</things-i18n-msg>
      <things-i18n-msg auto msgid="label.password" msg="{{lPassword}}" hidden>Password</things-i18n-msg>
      <things-i18n-msg auto msgid="label.sign_up" msg="{{lSignUp}}" hidden>Sign Up</things-i18n-msg>
      <things-i18n-msg auto msgid="label.reset_password" msg="{{lResetPass}}" hidden>Reset Password</things-i18n-msg>
      <things-i18n-msg auto msgid="label.active_request" msg="{{lRequestActive}}" hidden>Active Request</things-i18n-msg>

      <span class="header">
        <strong><things-i18n-msg auto msgid="label.login">LOGIN</things-i18n-msg></strong>
      </span>

        <form is="iron-form"
              id="loginForm"
              headers="[[headers]]"
              login-path="[[loginPath]]"
              action="{{action}}"
              content-type="[[contentType]]"
              method="[[method]]"
              with-credentials>

          <paper-input id="username"
                       name="email"
                       type="text"
                       label="[[lUserId]]"
                       value="{{username}}"
                       pattern="[[usernameValidationPattern]]"
                       error-message="[[usernameErrorMessage]]"
                       required
                       auto-validate
                       autofocus
                       tabindex='1'>
          </paper-input>

          <paper-input id="password"
                       name="password"
                       type="password"
                       label="[[lPassword]]"
                       value="{{password}}"
                       pattern="[[passwordValidationPattern]]"
                       error-message="[[passwordErrorMessage]]"
                       required
                       auto-validate
                       tabindex='2'>
          </paper-input>

          <div>
            <paper-button id="submitButton" raised on-tap="submitHandler" tabindex='3'>
              <things-i18n-msg auto msgid="button.sign_in">Sign In</things-i18n-msg>
            </paper-button>

            <paper-button on-tap="_onSignupTap">
              <things-i18n-msg auto msgid="button.sign_up">Sign Up</things-i18n-msg>
            </paper-button>

            <paper-button on-tap="_onRequestAccountActivateTap">
              <things-i18n-msg auto msgid="button.request_active">Request Active</things-i18n-msg>
            </paper-button>

            <paper-button on-tap="_onRequestPasswordResetTap">
              <things-i18n-msg auto msgid="button.reset_password">Reset Password</things-i18n-msg>
            </paper-button>
          </div>
        </form>
      </paper-material>
    </template>

    <script>
      Polymer({

        is: 'things-login',

        properties: {
          /**
           * Label for the title
           * @type {string}
           * @default Login
           */
          title: {
            type: String,
            value: 'Login'
          },

          /**
           * elevation(음영높이) for login form
           * @type {Number}
           */
          elevation: {
            type: Number,
            value: 4
          },

          /**
           * Pattern used to validate username,  ex: '^[a-zA-Z0-9]+$'
           * @type {string}
           */
          usernameValidationPattern: {
            type: String
          },

          /**
           * Error message displayed if `usernameValidationPattern` is not matched.
           * @type {string}
           */
          usernameErrorMessage: {
            type: String,
            value: 'letters and numbers only'
          },

          /**
           * Pattern used to validate password, ex: '^[a-zA-Z0-9]+$'
           * @type {string}
           */
          passwordValidationPattern: {
            type: String
          },

          /**
           * Error message displayed if `passwordValidationPattern` is not matched.
           * @type {string}
           */
          passwordErrorMessage: {
            type: Object,
            value: 'letters and numbers only'
          },

          /**
           * login request header
           * @type {Object}
           */
          headers: {
            type: Object
          },

          /**
           * login request url except basic url
           * @type {Object}
           */
          loginPath: {
            type: String,
            notify: true
          },

          /**
           * login request full url
           * @type {Object}
           */
          action: {
            type: String,
            computed: '_computeActionUrl(globals.baseUrl, loginPath)'
          },

          /**
           * login request content type
           * @type {Object}
           */
          contentType: {
            type: String,
            value: 'application/x-www-form-urlencoded'
          },

          /**
           * login request method
           */
          method: {
            type: String,
            value: 'POST'
          },

          /**
           * Label for the submit button
           * @type {string}
           * @default Submit
           */
          submitLabel: {
            type: String,
            value: 'Submit'
          },

          /**
           * OI 화면을 사용할 지 여부
           */
          useOiScreen: {
            type: Boolean,
            value: false
          },

          /**
           * OI 화면 URL
           */
          oiScreenPath: {
            type: String,
            value: 'index_io.html'
          },

          redirectCallback:{
            type: Object,
            value: function(){
              return function(){
                return true
              }
            }
          },


          /*
           * 로그인 성공 후 마지막에 접속했던 페이지로 이동할 지 여부
           */
          redirectToLastPageWhenLoggedIn: {
            type: Boolean,
            value: false
          }

          /**
           * 로그인 성공시 fire
           *
           * @event things-login-succeed
           */
        },

        behaviors: [
          Things.GlobalBehavior,
          Things.MsgBoxBehavior
        ],

        listeners: {
          'change': 'onFormChange',
          'iron-form-submit': '_afterFormSubmit',
          'iron-form-response': '_successResponse',
          'iron-form-error': '_failureResponse'
        },

        /**
         * compute action url of sign in
         */
        _computeActionUrl: function(baseUrl, url) {
          return baseUrl + '/' + url;
        },

        /**
         * Form change
         */
        onFormChange: function(event) {
        },

        /**
         * Signup button tap
         */
        _onSignupTap: function(event) {
          var signup = document.createElement('things-signup');
          signup.title = this.lSignUp;
          signup.actionUrl = 'request_auths/account/register/request'
          signup.method = 'POST';

          signup.addEventListener('things-signup-success', function(event) {
            var event = new CustomEvent('things-close-popup-view', { detail: this });
            document.dispatchEvent(event);
          });

          signup.addEventListener('things-signup-failure', function(event) {
            var response = event.detail.request.xhr.response;
            this.openResponseError(response);
          })

          var event = new CustomEvent('things-open-popup-view', {
            detail: { view: signup, modal: true, openCallback: null }
          });

          document.dispatchEvent(event);
        },

        /**
         * Request account activation button tap
         */
        _onRequestAccountActivateTap: function(event) {
          var requestActive = document.createElement('things-request-active');
          requestActive.title = this.lRequestActive;
          requestActive.actionUrl = 'request_auths/account/activate/request';
          requestActive.method = 'POST';

          requestActive.addEventListener('things-request-active-success', function(event) {
            var event = new CustomEvent('things-close-popup-view', { detail: this });
            document.dispatchEvent(event);
          });

          requestActive.addEventListener('things-request-active-failure', function(event) {
            var response = event.detail.request.xhr.response;
            this.openResponseError(response);
          })

          var event = new CustomEvent('things-open-popup-view', {
            detail: { view: requestActive, modal: true, openCallback: null }
          });

          document.dispatchEvent(event);
        },

        /**
         * Request password reset button tap
         */
        _onRequestPasswordResetTap: function(event) {
          var pwInit = document.createElement('things-password-init');
          pwInit.title = this.lResetPass;
          pwInit.actionUrl = 'request_auths/password/reset/request';
          pwInit.method = 'POST';

          pwInit.addEventListener('things-password-init-success', function(event) {
            var event = new CustomEvent('things-close-popup-view', { detail: this });
            document.dispatchEvent(event);
          });

          pwInit.addEventListener('things-password-init-failure', function(event) {
            var response = event.detail.request.xhr.response;
            this.openResponseError(response);
          });

          var event = new CustomEvent('things-open-popup-view', {
            detail: { view: pwInit, modal: true, openCallback: null }
          });

          document.dispatchEvent(event);
        },

        /**
         * Submit button tap
         */
        submitHandler: function(event) {
          console.log(this.customStyle);
          if(this.$.loginForm.validate()){
            this.openInfoMsg({
              type: 'info',
              title: 'Sign-in Processing...',
              html: true,
              text: '<br/><h3><span>Please Wait.</span><h3>',
              showConfirmButton: false
            });

            this.$.submitButton.disabled = true;
            this.$.loginForm.submit();
          }
        },

        /**
         * Submit (Sign In) button tap
         */
        resetHandler: function(event) {
          this.$.loginForm.reset();
        },

        /**
         * On keypress
         */
        keypressHandler: function(event, detail, sender) {
          var code = event.keyCode;
          if (code == 13) {
            this.submitHandler(event);
          }
        },

        /**
         * After submit
         */
        _afterFormSubmit: function(event) {
          this.$.submitButton.disabled = false;
        },

        /**
         * After signed in
         */
        _successResponse: function(event) {
          submitButton.disabled = false;
          var user = event.detail.__data__.response;
          // 1. save user information
          if(user){
            this.set('globals.user', user);
            if(user.stomp_url){
              this.set('globals.wsUrl',user.stomp_url);
            }
          }
          console.log(this.root.customStyle);
          this.customStyle['--things-background-image'] ='url(/images/bg-rail.png), url(/images/bg-blue.png)'
          // 2. reset login form
          this.$.loginForm.reset();
          // 3. fire event
          this.fire('things-login-succeed');
          // 4. redirect
          this._redirectAfterLogin(user);
        },
        /**
         * Callback 호출
         */
        applyCallback: function(callback) {
          if(callback && typeof callback == 'function') {
            return callback.apply(this);
          }
          return true;
        },
        /**
         * Redirect after login success
         */
        _redirectAfterLogin: function(user) {
          if(this.applyCallback(this.redirectCallback)){
            if(this.useOiScreen && user.operator_flag === true) {
              location.href = this.oiScreenPath;
            } else {
              var redirectURL = '/'
              if(this.redirectToLastPageWhenLoggedIn)
                redirectURL = window.sessionStorage.getItem('lastURL') || '/'

              page(redirectURL);
              location.reload(true);
            }
          };
        },

        /**
         * After failed sigin in
         */
        _failureResponse: function(event) {
          this.$.submitButton.disabled = false;
          var response = event.detail.request.xhr.response

          if(response) {
            this.openResponseError(response);
          } else {
            response = event.detail.request;
            this.openUnkownError(response);
          }
        }
      });
    </script>
</dom-module>
