<!--
@license
Copyright (c) 2017, HatioLab Inc. All right reserved.
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-input/iron-input.html">
<link rel="import" href="../iron-form/iron-form.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-material/paper-material.html">
<link rel="import" href="../gold-email-input/gold-email-input.html">

<link rel="import" href="../things-i18n-msg/things-i18n-msg.html">
<link rel="import" href="../things-form/things-form-behavior.html">
<link rel="import" href="../things-resource-combo/things-code-combo.html">
<link rel="import" href="../things-resource-combo/things-resource-combo.html">
<link rel="import" href="../things-spinner/things-spinner-behavior.html">
<link rel="import" href="../things-msg-box-behavior/things-msg-box-behavior.html">
<link rel="import" href="../things-msg-box-behavior/things-assert-behavior.html">

<!--
## things-signup
ko-KR
### 회원가입 화면
-->

<dom-module id="things-signup">
  <template>
    <style>
      :host {
        @apply(--things-loose-padding)
      }
      paper-button {
        @apply(--things-button);
        float: right;
        margin-top: 15px;
      }
      .btn-submit {
        @apply(--things-button-important)
      }
    </style>

    <things-i18n-msg auto msgid="text.password_mismatch" msg="{{tPasswordMismatch}}" hidden>Password mismatch password and confirmed password.</things-i18n-msg>
    <things-i18n-msg auto msgid="text.invalid_input" msg="{{tInvalidInput}}" hidden>Invalid Input.</things-i18n-msg>
    <things-i18n-msg auto msgid="text.info_invalid" msg="{{tInfoInvalid}}" hidden>Typed information is not valid.</things-i18n-msg>
    <things-i18n-msg auto msgid="text.register_in_process" msg="{{tRegInProcess}}" hidden>User registering is on processing.</things-i18n-msg>
    <things-i18n-msg auto msgid="text.check_register_in_mail" msg="{{tCheckRegInMail}}" hidden>You can check result of acceptance through your email.</things-i18n-msg>

    <things-i18n-msg auto msgid="label.domain" msg="{{lDomain}}" hidden>Domain</things-i18n-msg>
    <things-i18n-msg auto msgid="label.login" msg="{{lLogin}}" hidden>Login ID</things-i18n-msg>
    <things-i18n-msg auto msgid="label.user_name" msg="{{lUserName}}" hidden>User Name</things-i18n-msg>
    <things-i18n-msg auto msgid="label.email_address" msg="{{lEmailAddress}}" hidden>Email Address</things-i18n-msg>
    <things-i18n-msg auto msgid="label.language" msg="{{lLocale}}" hidden>Locale</things-i18n-msg>
    <things-i18n-msg auto msgid="label.password" msg="{{lPassword}}" hidden>Current Password</things-i18n-msg>
    <things-i18n-msg auto msgid="label.confirmed_password" msg="{{lConfirmedPassword}}" hidden>Confirm Password</things-i18n-msg>

    <things-i18n-msg auto msgid="button.check_duplication" msg="{{bCheckDuplicate}}" hidden>Check Duplication</things-i18n-msg>
    <things-i18n-msg auto msgid="text.pls_check_id_duplicate" msg="{{tPlsCheckDuplicate}}" hidden>Please Check ID Duplication</things-i18n-msg>

    <things-ajax
      id="check-id-duplicate"
      method="GET"
      resource-url="users/exist/:id"
      resource-id="{{userLoginId}}">
    </things-ajax>

    <form
      is="iron-form"
      id="form"
      action=[[action]]
      headers="[[headers]]"
      content-type="application/json"
      method="[[method]]"
      last-response="{{lastResponse}}">
      <things-spinner id="thingsspinner"></things-spinner>
      <things-resource-combo required id="domain" name="domain_id" label="[[lDomain]]" resource-url="domains/list" items-prop="" label-path="name" value-path="id"></things-resource-combo>

      <things-code-combo id="locale" name="locale" label="[[lLocale]]" code-name="LOCALE"></things-code-combo>
      <div>
        <paper-button raised on-tap="_checkDuplication">[[bCheckDuplicate]]</paper-button>
        <paper-input id="userlogin" required auto-validate error-message="[[tInvalidInput]]" name="login" label="[[lLogin]]" value="{{loginId}}"></paper-input>        
      </div>
      <paper-input id="username" required name="name" label="[[lUserName]]"></paper-input>

      <gold-email-input id="email" auto-validate required name="email" label="[[lEmailAddress]]"></gold-email-input>

      <!--paper-input required name ="timezone" label="Timezone"></paper-input-->

      <paper-input id="pw" required name="encrypted_password" type="password" label="[[lPassword]]"></paper-input>

      <paper-input
        id="confirmed-pw"
        auto-validate
        required
        name="confirmed_password"
        type="password"
        label="[[lConfirmedPassword]]"
        validator="_passwordValidate"
        errorMessage="Password mismatch password and confirmed password">
      </paper-input>

      <paper-button class="btn-submit" raised on-click="_submitMyForm">
        <things-i18n-msg msgid="button.submit" auto>Submit</things-i18n-msg>
      </paper-button>

      <paper-button raised on-click="_resetMyForm">
        <things-i18n-msg msgid="button.reset" auto>Reset</things-i18n-msg>
      </paper-button>
    </form>
  </template>

  <script>
    Polymer({
      is: 'things-signup',

      behaviors: [
        Things.FormBehavior,
        Things.SpinnerBehavior,
        Things.MsgBoxBehavior,
        Things.AssertBehavior
      ],
      properties: {

        loginId: {
          type: String,
          observer: '_loginIdChanged'
        },

        /**
         * login 아이디 중복 체크 여부
         * @type Boolean
         */
        isDuplicateChecked: {
           type:Boolean,
           value:false
        }
      },

      listeners: {
        'iron-form-response': '_successResponseHandler',
        'iron-form-error': '_errorResponseHandler',
        'check-id-duplicate.things-ajax-response': '_checkDupliResponsed'
      },

      /**
       * loginid 필드의 값이 변경될 때 마다 호출되어
       * 중복 체크 결과를 저장하는 isDuplicateChecked의 값을 false로 초기화한다.
       * loginid의 필드 값이 변경 되면 duplicate checked를 다시 하도록 유도
       * 
       * @param  String loginId input field의 value
       */
      _loginIdChanged: function(loginId) {
        this.isDuplicateChecked = false;
      },

      /**
       * ID 중복 체크를 위한 ajax의 결과 값을 받는다.
       * 전달받은 event.detail의 값이 true면 중복 false면 중복 아님
       * 해당 값을 통해 올바른 메시지를 출력하고 isDuplicatedChecked의 값을 결정한다.
       * 
       * @param  Object event ajax response
       */
      _checkDupliResponsed:function(event) {
        var isDuplicated = event.detail;
        
        if(isDuplicated) {
          var dupliMsg = Things.DataGlobal.t('error.VALUE_IS_DUPLICATED', { value: this.lLogin});

          this.openConfirmMsg({
            type: 'error',
            title: this.bCheckDuplicate,
            text: dupliMsg
          });

        } else {
          var dupliMsg = Things.DataGlobal.t('label.success');
          this.openConfirmMsg({
            title: this.bCheckDuplicate,
            text: dupliMsg
          });          
          this.isDuplicateChecked = true;
        }
      },

      /**
       * 중복 체크 버튼을 통해 실행되며 loginId의 값이 올바른 패턴인지 _isValidPattern을 호출하여
       * 확인하고 올바른 형식의 패턴이면 서버에 중복되는 아이디가 있는지 확인하기 위하 ajax 호출
       * 만약 올바른 형식의 패턴이 아니면 input field의 invalid를 true로 변경하여 error message가 출력되게 한다.
       * @return {[type]} [description]
       */
      _checkDuplication: function() {
        var patternResult = this._isValidPattern(this.loginId);

        if(this.loginId && patternResult) {
          var checkIdDuplicate = this.$['check-id-duplicate'];
          checkIdDuplicate.resourceId = this.loginId;
          checkIdDuplicate.generateRequest();
        } else {
          this.$['userlogin'].invalid = true;
        }
      },

      /**
       * 전달받은 loginId가 아이디로 사용하기에 적절한 패턴을 갖고 있는지 확인하고 해당 결과를 리턴
       * @param  String  loginId 
       * @return Boolean
       */
      _isValidPattern: function(loginId) {
        var pattern = /^[a-zA-Z]{1}([a-zA-Z0-9]|[._]){3,19}$/;
        return (pattern.test(loginId));
      },      

      /**
       * ID등록 요청 성공시
       *****
       * @event things-signup-success
       * @param {Object} serializedForm
       */
      /**
       * ID등록 요청 성공시
       * @param  {Object} event iron-form-response
       * @return {null}
       */
      _successResponseHandler: function(event) {
        this.stopSpinner();
        var me = this;

        this.openConfirmMsg({
          title: this.tRegInProcess,
          text: this.tCheckRegInMail
        }, function() {
          if(this.isDuplicateChecked) { me.fire("things-signup-success", me.serializeMyForm()); }
        });

        this.fire('things-all-dialog-close');
      },
      /**
       * ID등록 요청 실폐시
       *****
       * @event things-signup-failure
       * @param {Object} ironRequest
       */
      /**
       * ID등록 요청 실폐시
       * @param  {Object} event iron-form-error
       * @return {null}
       */
      _errorResponseHandler: function(event) {
        this.stopSpinner();
        var me = this;
        this.fire("things-signup-failure",event.detail);
        
        this.openConfirmMsg({
          type: 'warning',
          title: this.tInvalidInput,
          text: this.tInfoInvalid
        });
      },
      /**
       * ID등록 요청 발송후
       *****
       * @event things-signup-submited
       */
      _submitMyForm: function(event) {
        if(this._validateForm()) {
          this.$['form'].submit();
          this.fire('things-signup-submited');
        }
      },

      /**
       * reset form
       * @param  Object event
       */
      _resetMyForm: function(event) {
        this.resetMyForm();
      },

      /**
       * form submit 이전에 유효성 검사를 수행한다.
       * 유효성 검사 도중 문제 발생시 throw 문제가 없다면 true를 리턴
       * @return Boolean
       */
      _validateForm: function(){
        this.assertNotEmpty(this.$.domain.value, 'domain');
        this.assertNotEmpty(this.$.locale.value, 'locale');
        this.assertNotEmpty(this.$.userlogin.value, 'login');
        this.dupliValidation();
        this.assertNotEmpty(this.$.username.value, 'user_name');
        this.assertNotEmpty(this.$.email.value, 'email');
        this.assertNotEmpty(this.$.pw.value, 'password');
        this.assertNotEmpty(this.$['confirmed-pw'].value, 'confirmed_password');
        this.assertEqual(this.$.pw.value, this.$['confirmed-pw'].value, 'password', 'confirmed_password');
        return true;
      },

      /**
       * isDuplicateChecked를 통해 아이디 중복 체크를 수행했는지 여부를 판단한다.
       * 판단 결과에 따라 메시지를 출력하고 throw
       */
      dupliValidation: function() {
        if(!this.isDuplicateChecked) {
          this.openConfirmMsg({
            type: 'error',
            title: this.bCheckDuplicate,
            text: this.tPlsCheckDuplicate
          });
          throw { msg: 'id duplication checking is not finished yet'};
        }
      },

      /**
       * 비밀번호 필드와 비밀번호 확인 필드의 값이 서로 동일한지 확인하고 해당 결과를 리턴
       * @return Boolean
       */
      _passwordValidate: function() {
        return this.$.pw.value === this.$['confirmed-pw'].value;
      }
    });
  </script>
</dom-module>
