<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-input/iron-input.html">
<link rel="import" href="../iron-form/iron-form.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-material/paper-material.html">
<link rel="import" href="../gold-email-input/gold-email-input.html">

<link rel="import" href="../things-i18n-msg/things-i18n-msg.html">
<link rel="import" href="../things-form/things-form-behavior.html">
<link rel="import" href="../things-resource-combo/things-code-combo.html">
<link rel="import" href="../things-resource-combo/things-resource-combo.html">
<link rel="import" href="../things-spinner/things-spinner-behavior.html">
<link rel="import" href="../things-msg-box-behavior/things-msg-box-behavior.html">
<link rel="import" href="../things-msg-box-behavior/things-assert-behavior.html">

<!--
## things-signup
ko-KR
### 회원가입 화면
-->

<dom-module id="things-signup">
  <template>
    <style>
      :host {
        @apply(--things-loose-padding)
      }

      paper-button {
        @apply(--things-button);
        float: right;
        margin-top: 15px;
      }

      .btn-submit {
        @apply(--things-button-important)
      }
    </style>

    <things-i18n-msg auto msgid="text.password_mismatch" msg="{{tPasswordMismatch}}" hidden>Password mismatch password and confirmed password.</things-i18n-msg>
    <things-i18n-msg auto msgid="text.invalid_input" msg="{{tInvalidInput}}" hidden>Invalid Input.</things-i18n-msg>
    <things-i18n-msg auto msgid="text.info_invalid" msg="{{tInfoInvalid}}" hidden>Typed information is not valid.</things-i18n-msg>
    <things-i18n-msg auto msgid="text.register_in_process" msg="{{tRegInProcess}}" hidden>User registering is on processing.</things-i18n-msg>
    <things-i18n-msg auto msgid="text.check_register_in_mail" msg="{{tCheckRegInMail}}" hidden>You can check result of acceptance through your email.</things-i18n-msg>

    <things-i18n-msg auto msgid="label.domain" msg="{{lDomain}}" hidden>Domain</things-i18n-msg>
    <things-i18n-msg auto msgid="label.login" msg="{{lLogin}}" hidden>Login ID</things-i18n-msg>
    <things-i18n-msg auto msgid="label.user_name" msg="{{lUserName}}" hidden>User Name</things-i18n-msg>
    <things-i18n-msg auto msgid="label.email_address" msg="{{lEmailAddress}}" hidden>Email Address</things-i18n-msg>
    <things-i18n-msg auto msgid="label.language" msg="{{lLocale}}" hidden>Locale</things-i18n-msg>
    <things-i18n-msg auto msgid="label.password" msg="{{lPassword}}" hidden>Current Password</things-i18n-msg>
    <things-i18n-msg auto msgid="label.confirmed_password" msg="{{lConfirmedPassword}}" hidden>Confirm Password</things-i18n-msg>


    <things-ajax
      id="get-userid-ajax"
      method="GET"
      resource-url="users/exist/:id"
      resource-id="{{userLoginId}}"
      last-response="{{userExist}}">
    </things-ajax>


    <form
      is="iron-form"
      id="form"
      action=[[action]]
      headers="[[headers]]"
      content-type="application/json"
      method="[[method]]"
      last-response="{{lastResponse}}">
      <things-spinner id="thingsspinner"></things-spinner>
      <things-resource-combo required id="domain" name="domain_id" label="[[lDomain]]" resource-url="domains/list" items-prop="" label-path="name" value-path="id"></things-resource-combo>

      <things-code-combo id="locale" name="locale" label="[[lLocale]]" code-name="LOCALE"></things-code-combo>
      <paper-button raised on-click="_loginIdRepeatCheck">
        <things-i18n-msg msgid="button.repeat-check" auto>Repeat Check</things-i18n-msg>
      </paper-button>
      <paper-input id="userlogin" required name="login" label="[[lLogin]]"></paper-input>
      <things-i18n-msg id="i18nmsg" auto></things-i18n-msg>
      <paper-input id="username" required name="name" label="[[lUserName]]"></paper-input>

      <gold-email-input auto-validate required name="email" label="[[lEmailAddress]]"></gold-email-input>

      <!--paper-input required name ="timezone" label="Timezone"></paper-input-->

      <paper-input id="pw" required name="encrypted_password" type="password" label="[[lPassword]]"></paper-input>

      <paper-input
        id="confirmed-pw"
        auto-validate
        required
        name="confirmed_password"
        type="password"
        label="[[lConfirmedPassword]]"
        validator="_passwordValidate"
        errorMessage="Password mismatch password and confirmed password">
      </paper-input>

      <paper-button class="btn-submit" raised on-click="_submitMyForm">
        <things-i18n-msg msgid="button.submit" auto>Submit</things-i18n-msg>
      </paper-button>

      <paper-button raised on-click="_resetMyForm">
        <things-i18n-msg msgid="button.reset" auto>Reset</things-i18n-msg>
      </paper-button>
    </form>
  </template>

  <script>
    Polymer({
      is: 'things-signup',

      behaviors: [
        Things.FormBehavior,
        Things.SpinnerBehavior,
        Things.MsgBoxBehavior,
        Things.AssertBehavior
      ],
      properties: {
        userLoginId:{
          type:String,
          value:''
        },
        repeatchecked:{
           type:Boolean,
           value:false
        }
      },

      listeners: {
        'iron-form-response': '_successResponseHandler',
        'iron-form-error': '_errorResponseHandler',
        'get-userid-ajax.things-ajax-response': 'openRepeatCheck'
      },
      openRepeatCheck:function(event){
         if(event.detail){
               this.$['i18nmsg'].msgid="text.repeatCheckMsg_3";
           }else{
             this.$['i18nmsg'].msgid="text.repeatCheckMsg_4";
             this.repeatchecked=true;
           }
      },
       isRegisterUserName: function(s)   {
        var patrn=/^[a-zA-Z]{1}([a-zA-Z0-9]|[._]){3,19}$/;
        if (patrn.exec(s)) return false
        return true
      },
      /**
       * login id 중복 체크
       */
      _loginIdRepeatCheck:function(){
          this.userLoginId=this.$['userlogin'].value;

          if(this.$.userlogin.value==""){
           this.$['i18nmsg'].msgid="text.repeatCheckMsg_1";
         }else if(this.isRegisterUserName(this.$.userlogin.value)){
             this.$['i18nmsg'].msgid="text.repeatCheckMsg_2";
          }else{
         this.$['get-userid-ajax'].generateRequest();
       }
      },
      /**
       * ID등록 요청 성공시
       *****
       * @event things-signup-success
       * @param {Object} serializedForm
       */
      /**
       * ID등록 요청 성공시
       * @param  {Object} event iron-form-response
       * @return {null}
       */
      _successResponseHandler: function(event) {
        this.stopSpinner();
        var me = this;

        this.openConfirmMsg({
          title: this.tRegInProcess,
          text: this.tCheckRegInMail
        }, function() {
          if(this.repeatchecked){me.fire("things-signup-success", me.serializeMyForm());}
        });
      },
      /**
       * ID등록 요청 실폐시
       *****
       * @event things-signup-failure
       * @param {Object} ironRequest
       */
      /**
       * ID등록 요청 실폐시
       * @param  {Object} event iron-form-error
       * @return {null}
       */
      _errorResponseHandler: function(event) {
        this.stopSpinner();
        var me = this;
        this.fire("things-signup-failure",event.detail);
        this.openConfirmMsg({
          type: 'warning',
          title: this.tInvalidInput,
          text: this.tInfoInvalid
        });
      },
      /**
       * ID등록 요청 발송후
       *****
       * @event things-signup-submited
       */

      _submitMyForm: function(event) {
        if(this.repeatchecked){
        if (this._validateForm()){
          this.$['form'].submit();
          this.fire('things-signup-submited');
        }}else{
         this.$['i18nmsg'].msgid="text.repeatCheckMsg_5";
        }
      },

      _resetMyForm: function(event) {
        this.resetMyForm();
      },

      _validateForm: function(){
        this.assertNotEmpty(this.$.domain.value, 'domain');
        this.assertNotEmpty(this.$.locale.value, 'locale');
        this.assertNotEmpty(this.$.pw.value, 'password');
        this.assertNotEmpty(this.$['confirmed-pw'].value, 'confirmed_password');
        this.assertEqual(this.$.pw.value, this.$['confirmed-pw'].value, 'password', 'confirmed_password');
        return true;
      },

      _passwordValidate: function() {
        return this.$.pw.value === this.$['confirmed-pw'].value;
      }
    });
  </script>
</dom-module>
